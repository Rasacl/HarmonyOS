import { getTaskList } from '../../../api'
import { TaskInfoItem, TaskListParams, TaskListParamsModel, TaskTypeEnum } from '../../../models'
import TaskItemCard  from './TaskItemCard'
import promptAction from '@ohos.promptAction'
@Preview
@Component
struct TaskList {
  @State queryParams:TaskListParamsModel = new TaskListParamsModel({
    page:1,
    pageSize:5,
    status: TaskTypeEnum.Waiting
  } as TaskListParams)

  @State
  taskListData: TaskInfoItem[] = []
  allPage: number = 1 // æ€»é¡µæ•°å…ˆè®¾ç½®ä¸º1é¡µ åŽç»­ä¼šæ›´æ–°
  @State loading:boolean = false // æ˜¯å¦æ­£åœ¨åŠ è½½æ•°æ®
  // aboutToAppear(){
  //   this.getTaskList()
  // }  //onReachEndä¼šè§¦å‘è¯·æ±‚
  async getTaskList(){
    const result = await getTaskList(this.queryParams)
    // ...æ˜¯é™åˆ¶ä½¿ç”¨ åœ¨æ•°ç»„ä¸­å¯ç”¨
    this.taskListData = this.taskListData.concat(result.items) // è¿žæŽ¥æ–°çš„æ•°ç»„
    this.allPage = result.pages // èµ‹å€¼æ€»é¡µæ•°
    this.queryParams.page++ // é¡µç +1
  }
  build() {
    List(){
      ForEach(this.taskListData, (item:TaskInfoItem) => {
        ListItem(){
          TaskItemCard({taskItemData:item})
        }
      })
      ListItem() //Nextç‰ˆæœ¬ä¸éœ€è¦åŠ ListItemä¾ç„¶å¯ä»¥è§¦å‘onReachEnd
    }
    .onReachEnd(async () => {
      // è¿›è¡Œåˆ†é¡µåŠ è½½ è¿˜æ²¡æœ‰åŠ è½½å®Œçš„æƒ…å†µä¸‹è¿˜å¯ä»¥ç»§ç»­åŠ è½½ï¼Œå¦‚æžœåŠ è½½å®Œæˆå°±ä¸èƒ½åœ¨ç»§ç»­åŠ è½½äº†
      if(this.allPage >= this.queryParams.page){
        if(!this.loading){
          this.loading = true
          await this.getTaskList()
          this.loading = false
        }
      }else {
        promptAction.showToast({
          message:'åˆ°åº•å•¦ðŸ˜€ðŸ˜€ðŸ˜€'
        })
      }
    })
  }
}
export default  TaskList
